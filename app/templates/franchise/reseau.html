{% extends 'franchise/base_franchise.html' %}
{% from 'includes/seo_tags.html' import render_meta_tags, render_structured_data %}
{% block title %}Notre réseau d'écoles de wingfoil - Wing4All{% endblock %}

{% block seo %}
    {{ render_meta_tags(meta_tags) }}
    {% if structured_data %}
        {{ render_structured_data(structured_data) }}
    {% endif %}
{% endblock %}

{% block head %}
    <!-- Inclure les fichiers CSS de Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        .site-card {
            position: relative;
            background-color: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
            cursor: pointer;
        }
        .site-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .site-card-image {
            height: 200px;
            width: 100%;
            background-size: cover;
            background-position: center;
        }
        .site-card-content {
            padding: 20px;
        }
        .site-card-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid content-text homepage-container">
    <div class="row justify-content-center">
        <div class="col-12 text-center">
            <div class="content-box p-4 rounded">
                <h2 class="mb-4"><strong>Notre réseau d'écoles de wingfoil</strong></h2>
                <p class="lead mb-4">
                    <strong>Découvrez nos points de location dans les meilleurs spots de wingfoil en France</strong>
                </p>
                
                <div class="row mb-5">
                    <div class="col-12">
                        <div id="map" style="height: 500px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid content-text mt-5">
    <div class="row justify-content-center">
        <div class="col-12 text-center">
            <div class="content-box p-4 rounded">
                <h2 class="mb-4"><strong>Liste des sites Wing4All</strong></h2>
                
                <div class="row justify-content-center">
                    {% for site in sites %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="site-card" onclick="window.location='{{ url_for('main.site_home', site_slug=site.slug) }}'">
                                <div class="site-card-image" style="background-image: url('{{ url_for('static', filename='img/base/sites/' + site.slug + '.png') }}')"></div>
                                <div class="site-card-content">
                                    <h3>{{ site.name }}</h3>
                                    <p>{{ site.description }}</p>
                                    <p><strong>Adresse:</strong> {{ site.address }}, {{ site.postal_code }} {{ site.city }}</p>
                                    <p><strong>Contact:</strong> {{ site.phone }}</p>
                                </div>
                                <a href="{{ url_for('main.site_home', site_slug=site.slug) }}" class="site-card-overlay" aria-label="Voir le site {{ site.name }}"></a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid content-text mt-5">
    <div class="row justify-content-center">
        <div class="col-12 text-center">
            <div class="content-box p-4 rounded">
                <h2 class="mb-4"><strong>Rejoindre le réseau Wing4All</strong></h2>
                <p class="lead mb-4">
                    <strong>Vous êtes passionné de wingfoil et souhaitez ouvrir une franchise Wing4All dans votre région ? Contactez-nous pour découvrir les opportunités d'affaires et bénéficier de notre expertise.</strong>
                </p>
                <div class="text-center mt-4">
                    <a href="{{ url_for('main.contact_franchise') }}" class="btn btn-primary btn-lg">Nous contacter</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Inclure le script de Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<script>
    // Script pour initialiser la carte avec les marqueurs des sites
    function initMap() {
        // Coordonnées centrales pour la France
        var franceCenter = [46.603354, 1.888334];
        
        console.log('Initialisation de la carte...');
        
        // Création de la carte
        var map = L.map('map').setView(franceCenter, 6);
        
        // Ajout de la couche OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Récupération des sites depuis les données transmises par le backend
        var sitesData = {{ sites_json | safe }};
        console.log('Données des sites reçues:', sitesData);
        
        // Vérifier que nous avons des sites à afficher
        if (!sitesData || sitesData.length === 0) {
            console.error('Aucun site avec coordonnées valides à afficher.');
            return;
        }
        
        // Ajout des marqueurs pour chaque site
        sitesData.forEach(function(site) {
            console.log('Ajout du marqueur pour:', site.name, 'à la position:', site.lat, site.lng);
            try {
                var marker = L.marker([site.lat, site.lng])
                    .addTo(map)
                    .bindPopup(
                        '<div class="site-popup">' + 
                            '<h5>' + site.name + '</h5>' + 
                            '<p>' + site.description + '</p>' +
                            '<p><a href="/site/' + site.slug + '" class="btn btn-sm btn-primary">Visiter ce site</a></p>' +
                        '</div>'
                    );
            } catch (error) {
                console.error('Erreur lors de l\'ajout du marqueur pour', site.name, ':', error);
            }
        });
    }
    
    // Initialisation de la carte au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        try {
            initMap();
        } catch (error) {
            console.error('Erreur lors de l\'initialisation de la carte:', error);
        }
    });
</script>
{% endblock %}